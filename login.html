<!DOCTYPE html>
<html>
<head>
      <title>SEVERENITY | LOGIN</title>
      <meta charset = "utf-8">
      <meta http-equiv = "X-UA-Compatible" content = "IE = edge chrome=1">
      <meta name = "viewport" content = "width = device-width, initial-scale = 1, user-scalable=no">      
      <!-- Bootstrap -->
      <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> -->
      <!-- Icons -->
      <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->
      <link rel="shortcut icon" href="images/severenity_logo.ico" />
      <!-- Custom style -->
      <link rel="stylesheet" type="text/css" href="styles/style.css">
      <!-- JQuery -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
      <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
      <!-- Fonts -->
      <link rel="stylesheet" type="text/css" href="fonts/roboto/font.css">

      <link rel="stylesheet" media="all" href="styles/animate.css">
      <link rel="stylesheet" media="all" href="styles/particles.css">
      <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
      <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">

      <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>
      <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-app.js"></script>
      <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase-auth.js"></script>
      <script>
      var config = {
          apiKey: "AIzaSyCSulplJ1yBCcEWQlGASqvOWQFQ0npNDdU",
          authDomain: "sample-game-777.firebaseapp.com",
          databaseURL: "https://sample-game-777.firebaseio.com",
          projectId: "sample-game-777",
          storageBucket: "sample-game-777.appspot.com",
          messagingSenderId: "967925944048"
      };
      firebase.initializeApp(config);
      </script>

</head>
<body class="height100">
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '912233188857453',
      cookie     : true,
      xfbml      : true,
      version    : 'v2.10'
    });
      
    FB.AppEvents.logPageView();  
    $(document).trigger('fbload'); 
      
  };


</script>

<!-- particles.js container -->
<div id="particles-js"></div>

<!-- Login -->

<div class="login_part">
      <div class="login_form">
            <div class="login_header">
                  <img src="images/severenity.png" class="login_logo">
            </div>
            <p class="welcome_text">Login to quest <span class="lila">builder!</span></p>
            <form>
                  <center>
                        <span class="unable_overlay">
                              <label><img src="images/user_icon.png" class="login_icon"></label>
                              <input type="username" name="username" class="login_input" placeholder="Username">
                              <br><br>
                              <label><img src="images/lock_icon.png" class="login_icon"></label>
                              <input type="password" name="password" class="login_input" placeholder="Password"><br><br><br>
                        </span>
                        <button class="login_button" type="submit">
                        <p>Login with Facebook</p>
                        <div id="floatingCirclesG" class="none">
                              <div class="f_circleG" id="frotateG_01"></div>
                              <div class="f_circleG" id="frotateG_02"></div>
                              <div class="f_circleG" id="frotateG_03"></div>
                              <div class="f_circleG" id="frotateG_04"></div>
                              <div class="f_circleG" id="frotateG_05"></div>
                              <div class="f_circleG" id="frotateG_06"></div>
                              <div class="f_circleG" id="frotateG_07"></div>
                              <div class="f_circleG" id="frotateG_08"></div>
                        </div>
                        <img src="images/arrow.png" class="login_arrow">
                        </button>
                        <p id="error" class="none">*There was en error! Try again!</p>
                  </center>
            </form>
      </div>
</div>



<p id="crypto" class="none"></p>
<div id="fb-root"></div>


























<script>

$(document).ready(function () {
      function checkLoginState() {
        FB.getLoginStatus(function(response) {
          statusChangeCallback(response);
        });

      }

});
$(document).on('fbload', function(){
      console.log('START!')
      FB.api(
            '2008153942773241' + '/picture',
            'GET',
            {},
            function(response) {
                  console.log(response)
        }
      );
    }
);


(function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "https://connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
      
$('.login_button').click(function(e){
      $('#floatingCirclesG').toggleClass('none')
      $('.login_arrow').toggleClass('none')
      $('.login_button p').html('Logging you in ...')
      console.log('gere');
      // $.ajax({
      //       url: 'https://severenity-develop.herokuapp.com/quests',
      //       type: 'GET',
      //       crossDomain: true,
      //       dataType: 'json',
      //       success: function(response) {
      //             console.log(response);
      //       }
      // });

      var status1 = $.Deferred();
      e.preventDefault()

      //here we try to check the login status
      console.log('165');
      FB.getLoginStatus(function(response) {
            console.log('166');
            console.log(response)
            //we receive response about user login status
            if (response.status == 'unknown' || response.status == 'not_authorized') {
                  console.log('if');
                  //if user isn`t logged in, we authorize him via Firebase opening a new window
                  var provider = new firebase.auth.FacebookAuthProvider();
                  firebase.auth().signInWithPopup(provider).then(function(result) {
                    // This gives a Facebook Access Token. We can use it to access the Facebook API.
                    var token = result.credential.accessToken;
                    // The signed-in user info.
                    var user = result.user;
                    console.log(result)
                    id = result.user.providerData[0].uid
                    console.log(id)
                    status1.resolve();
                  console.log('resolved status1')
                  }).catch(function(error) {
                        // Handle Errors here.
                        var errorCode = error.code;
                        var errorMessage = error.message;
                        // The email of the user's account used.
                        var email = error.email;
                        // The firebase.auth.AuthCredential type that was used.
                        var credential = error.credential;
                        console.log(errorCode, errorMessage, email, credential)
                        $('#error').removeClass('none')
                        $('#floatingCirclesG').toggleClass('none')
                        $('.login_arrow').toggleClass('none')
                        $('.login_button p').html('Enter')
                        $('.login_form form').find(".login_input").val("")
                        status1.resolve();
                        console.log('resolved status1')
                  });
            }else{
                  console.log('else');
                  //if user is logged in we request for his ID
                  id = response.authResponse.userID
                  status1.resolve();
                  console.log('resolved status1')
                  var encrypted = CryptoJS.AES.encrypt(response.authResponse.accessToken, "SecretPassphrase2");
                        
                  document.getElementById("crypto").innerHTML = encrypted;
                  encrypted = $("#crypto").html()
                  console.log('encrypted accessToken', encrypted)
                  Cookies.set('accessToken', encrypted, { expires: 1 });
            }
      })

      $.when(status1).done(function(){

      console.log('went on');
      console.log('sent id', id)
      $.ajax({
            url: 'https://severenity-server-java.herokuapp.com/users/' + id,
            type: 'GET',
            crossDomain: true,
            dataType: 'json',
            success: function(response) {
                  console.log(response, response.result, response.data.userId);
                  if (response.result == 'success') {
                        //Cookies.remove('userID', { path: '' })
                        var encrypted = CryptoJS.AES.encrypt(response.data.userId, "SecretPassphrase");
                        
                        document.getElementById("crypto").innerHTML = encrypted;
                        encrypted = $("#crypto").html()
                        console.log('encrypted userID', encrypted)
                        Cookies.set('userID', encrypted, { expires: 1 });

                        $('#error').addClass('none')

                        window.location.href = 'dashboard.php';
                  }else{
                        $('#error').removeClass('none')
                        $('#floatingCirclesG').toggleClass('none')
                        $('.login_arrow').toggleClass('none')
                        $('.login_button p').html('Enter')
                        $('.login_form form').find(".login_input").val("")
                  }
                  
                   
            },
            error: function(error) {
                  console.log(error);
                  $('#error').removeClass('none')
                  $('#floatingCirclesG').toggleClass('none')
                  $('.login_arrow').toggleClass('none')
                  $('.login_button p').html('Enter')
                  $('.login_form form').find(".login_input").val("")
            }
      });

      }).promise();

})

</script>


<!-- scripts -->
<script src="particles/particles.js"></script>
<script src="js/app.js"></script>



<script>

$('div').click( function(){});
$('img').click( function(){});
$('button').click( function(){});

</script>

</body>
</html>